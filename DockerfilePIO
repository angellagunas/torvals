FROM pio-0.12.1:latest

USER root
ENV NODE_ENV production
RUN npm config set -g production false

# Install dependencies.
ADD package.json /tmp/package.json
RUN cd /tmp && npm --unsafe-perm install
RUN mkdir -p /app && cp -a /tmp/node_modules /app/

RUN pip install numpy

# Copy application code.
ADD . /app
ADD ./pio-code/engines /engines
ADD ./pio-code/env /env
RUN chown -R pio /engines
RUN chown -R pio /env

USER pio

WORKDIR /app

ENV NODE_ENV="production"

# Run tracker
CMD ./pio-initialize.sh
