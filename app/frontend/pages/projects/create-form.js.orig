<<<<<<< HEAD
import React, { Component } from 'react'
import { FormattedMessage, injectIntl } from 'react-intl'
import api from '~base/api'
import tree from '~core/tree'
=======
import React, { Component } from 'react';
import api from '~base/api';
>>>>>>> release

import {
  BaseForm,
  TextWidget,
  TextareaWidget,
  SelectWidget,
} from '~base/components/base-form';

const status = [
  'new',
  'empty',
  'adjustment',
  'uploading',
  'uploaded',
  'preprocessing',
  'configuring',
  'processing',
  'reviewing',
  'ready',
  'conciliated',
  'pendingRows',
  'error',
  'cloning',
  'updating-rules',
  'pending-configuration'
]

const statusName = [
  'Nuevo',
  'Sin datos',
  'Ajuste',
  'Cargando',
  'Cargado',
  'Preprocesando',
  'Configurando',
  'Procesando',
  'Revisando',
  'Listo',
  'Conciliado',
  'Pendiente',
  'Error',
  'Clonando',
  'Actualizando reglas',
  'Configuración pendiente'
]

class ProjectForm extends Component {
  constructor(props) {
    super(props);
    this.state = {
      formData: this.props.initialState,
      apiCallMessage: 'is-hidden',
      apiCallErrorMessage: 'is-hidden',
      organizations: [],
    };

    this.schema = {
      type: 'object',
      title: '',
      required: ['name'],
      properties: {
<<<<<<< HEAD
        name: {type: 'string', title: this.formatTitle('projectConfig.name')},
        description: { type: 'string', title: this.formatTitle('projectConfig.description')}
      }
    }
=======
        name: { type: 'string', title: 'Nombre' },
        description: { type: 'string', title: 'Descripción' },
      },
    };
>>>>>>> release

    this.uiSchema = {
      name: { 'ui:widget': TextWidget },
      description: { 'ui:widget': TextareaWidget, 'ui:rows': 3 },
    };
  }

<<<<<<< HEAD
  formatTitle (id) {
    return this.props.intl.formatMessage({ id: id })
  }

  componentWillMount () {
    if (this.props.setAlert) { this.props.setAlert('is-white', ' ') }
=======
  componentWillMount() {
    if (this.props.setAlert) {
      this.props.setAlert('is-white', ' ');
    }
>>>>>>> release
  }

  errorHandler(e) {}

  changeHandler({ formData }) {
    this.setState({
      formData,
      apiCallMessage: 'is-hidden',
      apiCallErrorMessage: 'is-hidden',
    });
  }

  clearState() {
    this.setState({
      apiCallMessage: 'is-hidden',
      apiCallErrorMessage: 'is-hidden',
      formData: this.props.initialState,
    });
  }

<<<<<<< HEAD
  async updateStep () {
    try {
      let user = tree.get('user')
      if (user.currentOrganization.wizardSteps.project) {
        return
      }
      let url = '/app/organizations/' + user.currentOrganization.uuid + '/step'

      let res = await api.post(url, {
        step: {
          name: 'project',
          value: true
        }
      })

      if (res) {
        let me = await api.get('/user/me')
        tree.set('user', me.user)
        tree.set('organization', me.user.currentOrganization)
        tree.set('rule', me.rule)
        tree.set('role', me.user.currentRole)
        tree.set('loggedIn', me.loggedIn)
        tree.commit()
        return true
      } else {
        return false
      }
    } catch (e) {
      console.log(e)
      return false
    }
  }

  async submitHandler ({formData}) {
    if (this.props.submitHandler) this.props.submitHandler(formData)
=======
  async submitHandler({ formData }) {
    if (this.props.submitHandler) this.props.submitHandler(formData);
>>>>>>> release
    try {
      var data = await api.post(this.props.url, formData);
      if (this.props.load) {
        await this.props.load();
      }
<<<<<<< HEAD
      this.clearState()
      this.setState({...this.state, apiCallMessage: 'message is-success'})
      if (this.props.finishUp) this.props.finishUp(data.data)
      await this.updateStep()
      return
=======
      this.clearState();
      this.setState({ ...this.state, apiCallMessage: 'message is-success' });
      if (this.props.finishUp) this.props.finishUp(data.data);
      return;
>>>>>>> release
    } catch (e) {
      if (this.props.errorHandler) this.props.errorHandler(e);
      return this.setState({
        ...this.state,
        error: e.message,
        apiCallErrorMessage: 'message is-danger',
      });
    }
  }

  render() {
    let { canEdit } = this.props;
    var error;
    if (this.state.error) {
      error = <div>Error: {this.state.error}</div>;
    }

    let { editable } = this.props;

    if (editable) {
      this.uiSchema['status'] = {
        'ui:widget': SelectWidget,
        'ui:disabled': !this.props.isAdmin,
      };
      this.schema.properties['status'] = {
        type: 'string',
<<<<<<< HEAD
        title: this.formatTitle('projectConfig.status'),
        enum: status,
        enumNames: this.formatTitle('dates.locale') === 'en' ? status : statusName
      }
      this.uiSchema['showOnDashboard'] = {'ui:widget': SelectWidget}
=======
        title: 'Estado',
        enum: [
          'new',
          'empty',
          'adjustment',
          'uploading',
          'uploaded',
          'preprocessing',
          'configuring',
          'processing',
          'reviewing',
          'ready',
          'conciliated',
          'pendingRows',
          'error',
          'cloning',
          'updating-rules',
          'pending-configuration',
        ],
        enumNames: [
          'Nuevo',
          'Sin datos',
          'Ajuste',
          'Cargando',
          'Cargado',
          'Preprocesando',
          'Configurando',
          'Procesando',
          'Revisando',
          'Listo',
          'Conciliado',
          'Pendiente',
          'Error',
          'Clonando',
          'Actualizando reglas',
          'Configuración pendiente',
        ],
      };
      this.uiSchema['showOnDashboard'] = { 'ui:widget': SelectWidget };
>>>>>>> release
      this.schema.properties['showOnDashboard'] = {
        type: 'boolean',
        title: this.formatTitle('projectConfig.primary'),
        default: false,
<<<<<<< HEAD
        enum: [
          true,
          false
        ],
        enumNames: [
          this.formatTitle('projectConfig.yes'),
          this.formatTitle('projectConfig.no')
        ]
      }
=======
        enum: [true, false],
        enumNames: ['Si', 'No'],
      };
>>>>>>> release
    } else {
      delete this.uiSchema['status'];
      delete this.schema.properties['status'];
      delete this.uiSchema['showOnDashboard'];
      delete this.schema.properties['showOnDashboard'];
    }
    if (!canEdit) {
      this.uiSchema.name['ui:disabled'] = true;
      this.uiSchema.description['ui:disabled'] = true;
      if (this.uiSchema.status)
        this.uiSchema.status['ui:disabled'] = !this.props.isAdmin;
    } else {
      delete this.uiSchema.name['ui:disabled'];
      delete this.uiSchema.description['ui:disabled'];
      if (this.uiSchema.status) delete this.uiSchema.status['ui:disabled'];
    }

    if (this.uiSchema.status)
      this.uiSchema.status['ui:disabled'] = !this.props.isAdmin;
    if (this.state.formData.cycleStatus) {
      this.uiSchema['cycleStatus'] = {
        'ui:widget': TextWidget,
        'ui:disabled': true,
      };
      this.schema.properties['cycleStatus'] = {
        type: 'string',
<<<<<<< HEAD
        title: this.formatTitle('projectConfig.cycleStatus')
      }
=======
        title: 'Etapa actual del ciclo',
      };
>>>>>>> release
    }
    return (
      <div>
        <BaseForm
          schema={this.schema}
          uiSchema={this.uiSchema}
          formData={this.state.formData}
          onChange={e => {
            this.changeHandler(e);
          }}
          onSubmit={e => {
            this.submitHandler(e);
          }}
          onError={e => {
            this.errorHandler(e);
          }}
        >
          <div className={this.state.apiCallMessage}>
<<<<<<< HEAD
            <div className='message-body is-size-7 has-text-centered'>
              <FormattedMessage
                id='projectConfig.saved'
                defaultMessage={`Los datos se han guardado correctamente`}
              />
=======
            <div className="message-body is-size-7 has-text-centered">
              Los datos se han guardado correctamente
>>>>>>> release
            </div>
          </div>

          <div className={this.state.apiCallErrorMessage}>
            <div className="message-body is-size-7 has-text-centered">
              {error}
            </div>
          </div>
          {canEdit && this.props.children}
        </BaseForm>
      </div>
    );
  }
}

<<<<<<< HEAD
export default injectIntl(ProjectForm)
=======
export default ProjectForm;
>>>>>>> release
